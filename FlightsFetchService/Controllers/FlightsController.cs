using Microsoft.AspNetCore.Mvc;
using CommonClasses;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace FlightsFetchService.Controllers {
    [ApiController]
    [Route("[controller]")]
    public class FlightsController : Controller {
        private readonly ILogger<FlightsController> _logger;

        public FlightsController(ILogger<FlightsController> logger) {
            _logger = logger;
        }

        //[HttpGet("~/getArray")]
        //public IEnumerable<Flight> GetFlights() {

        //    List<Flight> flights = new List<Flight>();

        //    for (int i = 0; i < 10; i++) {
        //        Flight flight = new Flight("Lh123", "Lufthansa", 20, "MLA", "21", "economy", "extra", 100.0f);
        //        flights.Add(flight);
        //     }

        //    return flights;
        //}


        [HttpGet("~/getFlightsJson/{origin}/{destination}/{departureDate}/{seatClass}")]
        public async Task<string> GetJson(string origin, string destination, string departureDate, string seatClass) {
            var client = new HttpClient();
            var request = new HttpRequestMessage {
                Method = HttpMethod.Get,
                RequestUri = new Uri("https://skyscanner44.p.rapidapi.com/search-extended?adults=1&origin=" + origin + "&destination=" + destination + 
                                    "&departureDate=" + departureDate + "&currency=EUR&stops=0"), //MLA - Malta , MXP - Milan , example date - 2022-10-11
                Headers =
                    {
                        { "X-RapidAPI-Key", "911baca7a5mshad44fe6b3ba5b83p1cfb9bjsnec44e825cee0" },
                        { "X-RapidAPI-Host", "skyscanner44.p.rapidapi.com" },
                    },
                            };
            string response;
            using (var s = await client.SendAsync(request)) {
                s.EnsureSuccessStatusCode();
                response = await s.Content.ReadAsStringAsync();
                Console.WriteLine(s);
            }

            //response = "{\"itineraries\":{\"results\":[{\"id\":\"14151-2210112130--32356-0-14476-2210112330\",\"legs\":[{\"id\":\"14151-2210112130--32356-0-14476-2210112330\",\"origin\":{\"id\":14151,\"name\":\"Luqa Malta International\",\"displayCode\":\"MLA\"},\"destination\":{\"id\":14476,\"name\":\"Milan Malpensa\",\"displayCode\":\"MXP\"},\"durationInMinutes\":120,\"stopCount\":0,\"isSmallestStops\":true,\"departure\":\"2022-10-11T21:30:00\",\"arrival\":\"2022-10-11T23:30:00\",\"timeDeltaInDays\":0,\"carriers\":{\"marketing\":[{\"id\":-32356,\"name\":\"easyJet\"}],\"operationType\":\"fully_operated\"},\"segments\":[{\"id\":\"14151-14476-2210112130-2210112330--32356\",\"origin\":{\"flightPlaceId\":\"MLA\",\"parent\":{\"flightPlaceId\":\"MLA\",\"name\":\"Valletta\",\"type\":\"City\"},\"name\":\"Luqa Malta International\",\"type\":\"Airport\"},\"destination\":{\"flightPlaceId\":\"MXP\",\"parent\":{\"flightPlaceId\":\"MIL\",\"name\":\"Milan\",\"type\":\"City\"},\"name\":\"Milan Malpensa\",\"type\":\"Airport\"},\"departure\":\"2022-10-11T21:30:00\",\"arrival\":\"2022-10-11T23:30:00\",\"durationInMinutes\":120,\"flightNumber\":\"2598\",\"marketingCarrier\":{\"id\":-32356,\"name\":\"easyJet\",\"alternate_di\":\"EZ\"},\"operatingCarrier\":{\"id\":-32356,\"name\":\"easyJet\",\"alternate_di\":\"EZ\"}}]}],\"pricing_options\":[{\"agents\":[{\"id\":\"easy\",\"name\":\"easyJet\",\"is_carrier\":true,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":4.35,\"feedback_count\":26238,\"rating_breakdown\":{\"reliable_prices\":4.64038,\"clear_extra_fees\":4.671648,\"customer_service\":5,\"ease_of_booking\":4.616772,\"other\":3.46524}}],\"price\":{\"amount\":19.49,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T19:56:00\",\"quote_age\":48},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/easy/1/14151.14476.2022-10-11/air/airli/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=19.49&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T19%3A56%3A00&pqid=false\"},{\"agents\":[{\"id\":\"ctuk\",\"name\":\"Trip.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.66,\"feedback_count\":41652,\"rating_breakdown\":{\"reliable_prices\":3.440032,\"clear_extra_fees\":4.502724,\"customer_service\":4.991588,\"ease_of_booking\":4.281112,\"other\":2.419004}}],\"price\":{\"amount\":19.55,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T20:25:00\",\"quote_age\":19},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/ctuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=19.55&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T20%3A25%3A00&pqid=true\"},{\"agents\":[{\"id\":\"s1uk\",\"name\":\"BudgetAir\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.87,\"feedback_count\":23120,\"rating_breakdown\":{\"reliable_prices\":3.91344,\"clear_extra_fees\":4.484508,\"customer_service\":4.945756,\"ease_of_booking\":4.215248,\"other\":2.9052}}],\"price\":{\"amount\":30.2,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/s1uk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=30.20&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"opuk\",\"name\":\"Opodo\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":2.93,\"feedback_count\":9924,\"rating_breakdown\":{\"reliable_prices\":3.060784,\"clear_extra_fees\":3.938192,\"customer_service\":4.759816,\"ease_of_booking\":3.5263,\"other\":1.425592}}],\"price\":{\"amount\":32.88,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/opuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=32.88&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"eduk\",\"name\":\"eDreams\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":2.64,\"feedback_count\":13138,\"rating_breakdown\":{\"reliable_prices\":3.067892,\"clear_extra_fees\":3.887272,\"customer_service\":4.069376,\"ease_of_booking\":3.249936,\"other\":1.305468}}],\"price\":{\"amount\":32.88,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/eduk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=32.88&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"xpuk\",\"name\":\"Expedia\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":2.56,\"feedback_count\":6524,\"rating_breakdown\":{\"reliable_prices\":1.2449,\"clear_extra_fees\":4.263468,\"customer_service\":5,\"ease_of_booking\":2.949788,\"other\":1.7979}}],\"price\":{\"amount\":33.19,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/xpuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7CEconomy+Promo%7CY%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=33.19&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"skyp\",\"name\":\"Kiwi.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.54,\"feedback_count\":20070,\"rating_breakdown\":{\"reliable_prices\":3.640696,\"clear_extra_fees\":4.25848,\"customer_service\":4.526336,\"ease_of_booking\":4.154872,\"other\":2.59036}}],\"price\":{\"amount\":38,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T20:25:00\",\"quote_age\":19},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/skyp/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=38.00&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T20%3A25%3A00&pqid=true\"},{\"agents\":[{\"id\":\"lmuk\",\"name\":\"lastminute.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.57,\"feedback_count\":21540,\"rating_breakdown\":{\"reliable_prices\":3.79318,\"clear_extra_fees\":4.27208,\"customer_service\":4.748372,\"ease_of_booking\":4.061348,\"other\":2.385908}}],\"price\":{\"amount\":42.59,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/lmuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7CY%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=42.59&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"bcuk\",\"name\":\"Booking.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true}],\"price\":{\"amount\":42.97,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/bcuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=42.97&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"mtuk\",\"name\":\"Mytrip\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.34,\"feedback_count\":48709,\"rating_breakdown\":{\"reliable_prices\":3.765388,\"clear_extra_fees\":4.050948,\"customer_service\":4.622676,\"ease_of_booking\":3.995464,\"other\":1.917592}}],\"price\":{\"amount\":49.94,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/mtuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=49.94&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"gtuk\",\"name\":\"GotoGate\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":1.82,\"feedback_count\":17115,\"rating_breakdown\":{\"reliable_prices\":3.011716,\"clear_extra_fees\":3.786776,\"customer_service\":1,\"ease_of_booking\":3.404364,\"other\":1.147}}],\"price\":{\"amount\":49.94,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/gtuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-32356%7C2598%7C14151%7C2022-10-11T21%3A30%7C14476%7C2022-10-11T23%3A30%7C120%7C-%7C-%7C-&carriers=-32356&operators=-32356&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=49.94&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"}],\"deeplink\":\"https://www.skyscanner.net/transport/flights/mla/mxp/221011/config/14151-2210112130--32356-0-14476-2210112330?adults=1&adultsv2=1&cabinclass=economy&children=0&childrenv2=&destinationentityid=27544068&originentityid=33350111&inboundaltsenabled=false&infants=0&outboundaltsenabled=false&preferdirects=false&ref=home&rtn=0\"},{\"id\":\"14151-2210111020--31915-0-14476-2210111225\",\"legs\":[{\"id\":\"14151-2210111020--31915-0-14476-2210111225\",\"origin\":{\"id\":14151,\"name\":\"Luqa Malta International\",\"displayCode\":\"MLA\"},\"destination\":{\"id\":14476,\"name\":\"Milan Malpensa\",\"displayCode\":\"MXP\"},\"durationInMinutes\":125,\"stopCount\":0,\"isSmallestStops\":true,\"departure\":\"2022-10-11T10:20:00\",\"arrival\":\"2022-10-11T12:25:00\",\"timeDeltaInDays\":0,\"carriers\":{\"marketing\":[{\"id\":-31915,\"name\":\"Ryanair\"}],\"operationType\":\"fully_operated\"},\"segments\":[{\"id\":\"14151-14476-2210111020-2210111225--31915\",\"origin\":{\"flightPlaceId\":\"MLA\",\"parent\":{\"flightPlaceId\":\"MLA\",\"name\":\"Valletta\",\"type\":\"City\"},\"name\":\"Luqa Malta International\",\"type\":\"Airport\"},\"destination\":{\"flightPlaceId\":\"MXP\",\"parent\":{\"flightPlaceId\":\"MIL\",\"name\":\"Milan\",\"type\":\"City\"},\"name\":\"Milan Malpensa\",\"type\":\"Airport\"},\"departure\":\"2022-10-11T10:20:00\",\"arrival\":\"2022-10-11T12:25:00\",\"durationInMinutes\":125,\"flightNumber\":\"5971\",\"marketingCarrier\":{\"id\":-31915,\"name\":\"Ryanair\",\"alternate_di\":\"FR\"},\"operatingCarrier\":{\"id\":-30823,\"name\":\"Malta Air\",\"alternate_di\":\"\"}}]}],\"pricing_options\":[{\"agents\":[{\"id\":\"s1uk\",\"name\":\"BudgetAir\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.87,\"feedback_count\":23120,\"rating_breakdown\":{\"reliable_prices\":3.91344,\"clear_extra_fees\":4.484508,\"customer_service\":4.945756,\"ease_of_booking\":4.215248,\"other\":2.9052}}],\"price\":{\"amount\":18.59,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/s1uk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=18.59&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"skyp\",\"name\":\"Kiwi.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.54,\"feedback_count\":20070,\"rating_breakdown\":{\"reliable_prices\":3.640696,\"clear_extra_fees\":4.25848,\"customer_service\":4.526336,\"ease_of_booking\":4.154872,\"other\":2.59036}}],\"price\":{\"amount\":19,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T20:25:00\",\"quote_age\":19},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/skyp/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=19.00&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T20%3A25%3A00&pqid=true\"},{\"agents\":[{\"id\":\"ctuk\",\"name\":\"Trip.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.66,\"feedback_count\":41652,\"rating_breakdown\":{\"reliable_prices\":3.440032,\"clear_extra_fees\":4.502724,\"customer_service\":4.991588,\"ease_of_booking\":4.281112,\"other\":2.419004}}],\"price\":{\"amount\":19.8,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T20:25:00\",\"quote_age\":19},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/ctuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=19.80&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T20%3A25%3A00&pqid=true\"},{\"agents\":[{\"id\":\"ryan\",\"name\":\"Ryanair\",\"is_carrier\":true,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true}],\"price\":{\"amount\":19.99,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T17:51:00\",\"quote_age\":173},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/ryan/1/14151.14476.2022-10-11/air/airli/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7CD%7CValue&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=19.99&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T17%3A51%3A00&pqid=false\"},{\"agents\":[{\"id\":\"bcuk\",\"name\":\"Booking.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true}],\"price\":{\"amount\":32.52,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/bcuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=32.52&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"mtuk\",\"name\":\"Mytrip\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.34,\"feedback_count\":48709,\"rating_breakdown\":{\"reliable_prices\":3.765388,\"clear_extra_fees\":4.050948,\"customer_service\":4.622676,\"ease_of_booking\":3.995464,\"other\":1.917592}}],\"price\":{\"amount\":37.16,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/mtuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=37.16&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"gtuk\",\"name\":\"GotoGate\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":1.82,\"feedback_count\":17115,\"rating_breakdown\":{\"reliable_prices\":3.011716,\"clear_extra_fees\":3.786776,\"customer_service\":1,\"ease_of_booking\":3.404364,\"other\":1.147}}],\"price\":{\"amount\":37.16,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/gtuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=37.16&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"opuk\",\"name\":\"Opodo\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":2.93,\"feedback_count\":9924,\"rating_breakdown\":{\"reliable_prices\":3.060784,\"clear_extra_fees\":3.938192,\"customer_service\":4.759816,\"ease_of_booking\":3.5263,\"other\":1.425592}}],\"price\":{\"amount\":40.34,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/opuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=40.34&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"eduk\",\"name\":\"eDreams\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":2.64,\"feedback_count\":13138,\"rating_breakdown\":{\"reliable_prices\":3.067892,\"clear_extra_fees\":3.887272,\"customer_service\":4.069376,\"ease_of_booking\":3.249936,\"other\":1.305468}}],\"price\":{\"amount\":40.34,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/eduk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7C-%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=40.34&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"},{\"agents\":[{\"id\":\"lmuk\",\"name\":\"lastminute.com\",\"is_carrier\":false,\"update_status\":\"current\",\"optimised_for_mobile\":true,\"live_update_allowed\":true,\"rating_status\":\"available\",\"rating\":3.57,\"feedback_count\":21540,\"rating_breakdown\":{\"reliable_prices\":3.79318,\"clear_extra_fees\":4.27208,\"customer_service\":4.748372,\"ease_of_booking\":4.061348,\"other\":2.385908}}],\"price\":{\"amount\":43.43,\"update_status\":\"current\",\"last_updated\":\"2022-06-22T18:34:00\",\"quote_age\":130},\"url\":\"https://www.skyscanner.net/transport_deeplink/4.0/UK/en-GB/EUR/lmuk/1/14151.14476.2022-10-11/air/trava/flights?itinerary=flight%7C-31915%7C5971%7C14151%7C2022-10-11T10%3A20%7C14476%7C2022-10-11T12%3A25%7C125%7C-%7CD%7C-&carriers=-31915&operators=-30823&passengers=1&channel=website&cabin_class=economy&facilitated=false&ticket_price=43.43&is_npt=false&is_multipart=false&client_id=skyscanner_website&q_sources=JACQUARD&commercial_filters=false&q_datetime_utc=2022-06-22T18%3A34%3A00&pqid=true\"}],\"deeplink\":\"https://www.skyscanner.net/transport/flights/mla/mxp/221011/config/14151-2210111020--31915-0-14476-2210111225?adults=1&adultsv2=1&cabinclass=economy&children=0&childrenv2=&destinationentityid=27544068&originentityid=33350111&inboundaltsenabled=false&infants=0&outboundaltsenabled=false&preferdirects=false&ref=home&rtn=0\"}]},\"context\":{\"status\":\"complete\",\"sessionId\":\"a3cd849b-9770-4c52-9a78-60ac97188ce4\"}}";

            JObject returnJson = JsonConvert.DeserializeObject<JObject>(response);
            JArray results = (JArray)returnJson["itineraries"]["results"];

            Console.WriteLine(results.Count);


            List<Flight> flights = new List<Flight>();
            int i = 0;
            foreach (var result in results) {
                try {
                    int flightNum = int.Parse((string)returnJson["itineraries"]["results"][i]["legs"][0]["segments"][0]["flightNumber"]);
                    string airline = (string)returnJson["itineraries"]["results"][i]["legs"][0]["carriers"]["marketing"][0]["name"];
                    int durationInMinutes = int.Parse((string)returnJson["itineraries"]["results"][i]["legs"][0]["segments"][0]["durationInMinutes"]);
                    string originAirport = (string)returnJson["itineraries"]["results"][i]["legs"][0]["segments"][0]["origin"]["name"];
                    string destinationAirport = (string)returnJson["itineraries"]["results"][i]["legs"][0]["segments"][0]["destination"]["name"];
                    float flightPrice = float.Parse((string)returnJson["itineraries"]["results"][i]["pricing_options"][0]["price"]["amount"]);

                    Flight flight = new Flight(flightNum, airline, durationInMinutes, originAirport, destinationAirport, seatClass, flightPrice);
                    flights.Add(flight);
                } catch (Exception e) {
                    Console.WriteLine(e.Message);
                }


                i++;
            }

            return JsonConvert.SerializeObject(flights); ;
        }
    }
}
